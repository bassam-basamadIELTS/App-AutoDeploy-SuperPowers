---
  - name: display the files locations
    become: true
    shell : |
        echo *
        PWD
        cd backend
        echo *
        PWD

  - name: Copy files
    become: true
    copy:
      src: /root/project/backend/artifact.tar.gz
      dest: /home/ubuntu/artifact.tar.gz

  - name: Unarchive
    become: true
    shell : |
        cd /home/ubuntu/
        tar xvzf artifact.tar.gz -C .

  - name: "run server"
    become: true
    shell : |
        cd /home/ubuntu/
        npm install
        pm2 stop default
        pm2 start npm -- start
    
    environment:
      ENVIRONMENT: production
      TYPEORM_CONNECTION: "{{ lookup('env', 'TYPEORM_CONNECTION') }}"
      TYPEORM_MIGRATIONS_DIR: "./migrations"
      TYPEORM_MIGRATIONS: "./migrations/*.js"
      TYPEORM_ENTITIES: "./modules/domain/**/*.entity.js"
      TYPEORM_HOST: "{{ lookup('env', 'TYPEORM_HOST') }}"
      TYPEORM_PORT: "{{ lookup('env', 'TYPEORM_PORT') }}"
      TYPEORM_USERNAME: "{{ lookup('env', 'TYPEORM_USERNAME') }}"
      TYPEORM_PASSWORD: "{{ lookup('env', 'TYPEORM_PASSWORD') }}"
      TYPEORM_DATABASE: "{{ lookup('env', 'TYPEORM_DATABASE') }}"

  # - name: extract artifact
  #   become: true
  #   unarchive:
  #     src: files/artifact.tar.gz
  #     dest: .

  # - name: "Create backend app directory"
  #   file:
  #     path: ~/backend-app
  #     state: directory

  # - name: "Unarchive backend files"
  #   become: true
  #   unarchive:
  #     src: files/artifact.tar.gz
  #     dest: ~/backend-app
  
  # - name: "Installing Node Dependencies"
  #   shell: |
  #     cd ~/backend-app
  #     echo PWD
  #     # npm install
  
  # - name: "Executing Node app with PM2"
  #   shell: |
  #     cd ~/backend-app/dist
  #     pm2 stop default
  #     pm2 start main.js
    
  #   register: execute_code

  # - name: print_message
  #   debug:
  #     msg: "{{ execute_code.stdout_lines }}"

  # - name: "Configure pm2 to start as a service"
  #   become: true
  #   shell: |
  #     env PATH=$PATH:/usr/local/bin pm2 startup systemd -u ubuntu --hp  /home/ubuntu

